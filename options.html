<html>
<head>
</head>
<body>
<script src="jquery.js"></script>
<script src="oauth.js"></script>
<script src="sha1.js"></script>
<script type="text/javascript">
function decode(data) {
    var response;
    $.each(data.split('&'), function() {
        response[this.split('=')[0]] = this.split('=')[1];
    });

    return response;
}
var request_token_url = 'http://twitter.com/oauth/request_token';
var authorize_url     = 'http://twitter.com/oauth/authorize';
var access_url        = 'http://twitter.com/oauth/access_token';
var consumer_key      = 'ruXg6gDIBxihEyMd9jCHdQ';
var consumer_secret   = '5SLxFQ0WrXPfOC11dbIq8ASihJvecHEvHK4YvLuQq4';
var request_token;
var request_token_secret;

var accessor = {
    //token: "...",
    //tokenSecret: "...",
    consumerKey:    'ruXg6gDIBxihEyMd9jCHdQ',
    consumerSecret: '5SLxFQ0WrXPfOC11dbIq8ASihJvecHEvHK4YvLuQq4'
};

var message = {
    action: '',
    method: "GET",
    parameters: {}
};

$(function() {
    $("#sign_in").click(function(e) {
        // hide sign in input
        $("#sign_in").hide();
        // XXX start animation
        // request twitter auth token
        message.action = request_token_url;
        OAuth.completeRequest(message, accessor);
        OAuth.SignatureMethod.sign(message, accessor);
        request_token_url = request_token_url + '?' + OAuth.formEncode(message.parameters);

        $.get(request_token_url, function(data) {
            var response = decode(data);
            accessor.token       = response['oauth_token'];
            accessor.tokenSecret = response['oauth_token_secret'];
            request_token        = response['oauth_token'];
            request_token_secret = response['oauth_token_secret'];
            message.action = authorize_url;
            OAuth.completeRequest(message, accessor);
            OAuth.SignatureMethod.sign(message, accessor);
            authorize_url = authorize_url + '?' + OAuth.formEncode(message.parameters)

            // create tab, go to oauth/authorize URL
            chrome.tabs.create({ url: authorize_url });
            // show PIN input
            $("span.pin").show();
        });
    });

    $("#pin_submit").click(function() {
        // call oauth/access_token with PIN
        var final_accessor = {
            consumerKey : consumer_key,
            consumerSecret : consumer_secret,
            token : request_token,
            tokenSecret : request_token_secret,
            verifier : $("#pin").attr("value")
        };
        var final_message = {
            action : access_url,
            method : "POST",
            parameters : {}
        };
        OAuth.completeRequest(final_message, final_accessor);
        OAuth.SignatureMethod.sign(final_message, final_accessor);
        access_url = access_url + '?' + OAuth.formEncode(final_message.parameters)
        $.post(access_url, function(data) {
            response = decode(data);
            // XXX get access token; store in local storage?
        });
    });

});
</script>
<h1>tab tweet</h1>

<input id="sign_in" type="submit" value="Sign into Twitter" />
<span id="work" style="display:none;">Working...</span>
<span class="pin" style="display:none;">
    <input id="pin" type="text" />
    <input id="pin_submit" type="submit" value="Submit your 7-digit PIN from Twitter" />
</span>
</body>
</html>
